{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    {#<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />#}
{% endblock %}

{% block body %}

    <div class="row ">
        <h1 class="title">{{ challenge.nom }}</h1>
        <p class="callout">{{ challenge.description }}</p>

    </div>
    {% if challenge.type == 'private' %}
    {% else %}
        {% if challenge in user.chalenges %}
            <div class="text-center">
                <a href="{{ path('challenge_desinscription', {'id': challenge.id}) }}" class="button alert">Je me désinscrit</a>
            </div>
            {% else %}
            <div class="text-center">
                <a href="{{ path('challenge_public_inscription', {'id': challenge.id}) }}" class="button">Je participe !</a>
            </div>
        {% endif %}
    {% endif %}

    {% if image_meneur is not null %}
        <h4 class="title">Image du challenge</h4>
        <div class="text-center row">
            <img width="50%" src="{{ asset('uploads/promotion/') }}{{ image_meneur.src }}" alt="">
        </div>
        {% if image_meneur.users != user %}
            {% if image_user is null %}
                <div class="row align-middle">
                    {{ form_start(form) }}
                    {{ form_label(form.file, 'Télecharger une image', {'label_attr': {'class':'small button float-center' }}) }}
                    {{ form_widget(form.file, {'attr': {'class':'show-for-sr' }}) }}
                    {{ form_widget(form.lng, {'type': 'hidden'}) }}
                    {{ form_widget(form.lat, {'type': 'hidden'}) }}

                    <div class="text-center">
                        <img id="blah" src="#" alt="your image" />
                    </div>

                    <div class="text-center">
                        <input type="submit" class="success button" value="Proposer" />
                    </div>
                    {{ form_end(form) }}
                </div>
            {% else %}
                <h4 class="title">Image proposée</h4>
                <div class="row text-center">
                    <img src="{{ asset('uploads/promotion/') }}{{ image_user.src }}" alt="">
                </div>
            {% endif %}
        {% endif %}
        {% if images_user is not empty %}
            <div class="row align-center small-10 columns ">
                <div class="align-middle">
                    {% if images_user[0] is defined %}
                        <div class="row text-center">
                            <img src="{{ asset('uploads/promotion/') }}{{ images_user[0].src }}">
                        </div>
                        <div id="distance_between_too_shoot" class="text-center ">
                            {# distance entre les deux photos injecté en JS #}
                        </div>
                        <div class="text-center">
                            <a class="button success" href="{{ path('challenge_validation_img', {'id' : images_user[0].id }) }}">Valider</a>
                            <a class="button" href="{{ path('challenge_delete_wrong_img', {'id' : images_user[0].id }) }}">Refuser</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

    {% endif %}
    {#<div id="mapid"></div>#}
    {#<iframe class="float-center" width="425" height="350" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="http://www.openstreetmap.org/export/embed.html?bbox=1.8770313262939455%2C47.887657874983056%2C1.9128656387329104%2C47.90000235757435&amp;layer=mapnik&amp;marker=47.89383048413455%2C1.8949484825134277" style="border: 1px solid black"></iframe><br/><small><a href="http://www.openstreetmap.org/?mlat=47.8938&amp;mlon=1.8949#map=16/47.8938/1.8949">View Larger Map</a></small>    <div id="clockdiv"></div>#}


{% endblock %}
{% block javascripts %}
    {{ parent() }}
    {#<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>#}

    <script>
        var deadline = {{ deadline|date("d/m/Y") }};
    </script>

    <script>
        $('#blah').hide();
        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#blah').attr('src', e.target.result);
                    // Sur NEW masque l'image vide -- Changement de la class
                    $('.hide').toggleClass('hide responsive-img');
                    // Sur EDIT masque l'image initiale -- Changement de la class
                    $('.thumbs').toggleClass('thumbs hide');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        $("#gamebundle_image_file").change(function(){
            $('#blah').show();
            readURL(this);
        });

    </script>

    <script>

        ///////////////////////////////
        //      Géolocalisation
        ///////////////////////////////

        var x = document.getElementById("demo");
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }
        function showPosition(position) {
            $('#gamebundle_image_lat').val(position.coords.latitude);
            $('#gamebundle_image_lng').val(position.coords.longitude);
        }
        getLocation();
        showPosition();


//        // gestion de la carte via leaflet
//        var mymap = L.map('mapid').setView([51.505, -0.09], 13);
//
//        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
//            maxZoom: 18,
//            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
//            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
//            'Imagery © <a href="http://mapbox.com">Mapbox</a>',
//            id: 'mapbox.streets'
//        }).addTo(mymap);


        /////////////////////////////////////////
        // Distance entre deux prises de photo
        /////////////////////////////////////////
        {% if images_user[0] is defined %}

            var lat1 = {{ image_meneur.lat }};
            var lon1 = {{ image_meneur.lng }};
            var lat2 = {{ images_user[0].lat }};
            var lon2 = {{ images_user[0].lng }};
            function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
                var R = 6371; // Radius of the earth in km
                var dLat = deg2rad(lat2-lat1);  // deg2rad below
                var dLon = deg2rad(lon2-lon1);
                var a =
                        Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                        Math.sin(dLon/2) * Math.sin(dLon/2)
                    ;
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                var d = R * c; // Distance in km
                return d * 1000; // Distance in m
            }

            function deg2rad(deg) {
                return deg * (Math.PI/180)
            }
            var difference = Math.round(getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2));
            $( "#distance_between_too_shoot" ).append( "<p>Distance entre les deux lieux de prises: " + difference + " mètres </p>");

        {% endif %}

    </script>
{% endblock %}